@using Sandbox
@using Sandbox.UI

@implements INavigatorPage
@inherits Panel
@attribute [StyleSheet]
@namespace Facepunch.Gunfight.MainMenu

<root>
	<div class="main">
		<div class="left column grow">
			<div class="game-title">
				Gunfight
			</div>

			<div class="game-subtitle">
				Dying to get into the action?
			</div>

			<div style="flex-grow: 1;"/>

			<ExpandWidget>
				<Title>
					Modes
				</Title>
				<Body>
				<GamemodeList SelectedGamemode:bind=@SelectedMode />
				</Body>
			</ExpandWidget>

			<ActionButton onclick=@Return>
				<Title>
					Return
				</Title>
				<Extra>
					<Panel class="new"/>
				</Extra>
			</ActionButton>
		</div>

		<div style="flex-grow: 1;"/>

		<div class="right column grow">
			<div style="flex-grow: 1;"/>

			<ExpandWidget>
				<Title>
					<label>Maps - @SelectedMaps.Count selected</label>
				</Title>
				<Body>
				<PackageList OnUpdate=@OnMapSelectionChanged MaxSelection=@(0)>
					<WhenNothingFound>
						<label>No maps found...</label>
					</WhenNothingFound>
					<WhenSearching>
						<label>Searching for maps...</label>
					</WhenSearching>
				</PackageList>
				</Body>
			</ExpandWidget>

			<span style="gap: 16px;">
				<ActionButton onclick=@CreateLobby>
					<Title>
						Make Lobby
					</Title>
					<Extra>
						<i>wifi</i>
					</Extra>
				</ActionButton>
				<ActionButton onclick=@CreateServer>
					<Title>
						Quick-Start
					</Title>
					<Extra>
                        <i>right-to-bracket</i>
					</Extra>
				</ActionButton>
				<ActionButton class="icon-only" onclick=@Search>
					<Extra>
						<i>search</i>
					</Extra>
				</ActionButton>
			</span>

		</div>
	</div>
</root>

@code
{
    List<Package> SelectedMaps { get; set; } = new();
    string SelectedMode { get; set; } = "KillConfirmedGamemode";

    async void CreateServer( PanelEvent e )
    { 
        var lobby = await MatchmakingSystem.CreateLobby( Game.Random.FromArray( SelectedMaps.Select( x => x.FullIdent ).ToArray() ), SelectedMode );
        await lobby.LaunchGameAsync();
    }

	void OnMapSelectionChanged( List<Package> packages )
	{
		SelectedMaps = packages;
	}
	
	void Search()
	{	
		// TODO - Return error if we can't search?
		_ = StartSearching();
		
		if ( MatchmakingSystem.CurrentState != MatchmakingSystem.State.Empty ) this.Navigate( "/" );
	}

	async Task StartSearching()
	{
		// Need to select a map.
		if ( SelectedMaps.Count < 1 ) return;

		var result = await MatchmakingSystem.Matchmake( SelectedMode,
			SelectedMaps.Select( x => x.FullIdent ).ToArray() );

		if ( result == "lobby" )
		{
			this.Navigate( "/lobby" );
		}
	}
	
	void Return()
	{
		this.Navigate( "/" );
	}

	async Task CreateLobby()
	{
		if ( SelectedMaps.Count < 1 )
		{
			// TODO - Error
			return;
		}
		
        var lobby = await MatchmakingSystem.CreateLobby( Game.Random.FromArray( SelectedMaps.Select( x => x.FullIdent ).ToArray() ), SelectedMode );
	}
}
